---
name: Update

on:
  repository_dispatch:
    types:
      - update

jobs:
  update:
    name: ğŸ“¢ Update ${{ github.event.client_payload.addon }}
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@v4.1.0

      - name: âœï¸ Update add-on version
        run: |
          addon="${{ github.event.client_payload.addon }}"
          version="${{ github.event.client_payload.version }}"
          repository="${{ github.event.client_payload.repository }}"

          if [[ ! -f "${addon}/config.yaml" ]]; then
            echo "::error ::Add-on ${addon} not found in this repository"
            exit 1
          fi

          yq eval ".version = \"${version}\"" -i "${addon}/config.yaml"
          yq eval ".image = \"ghcr.io/${repository}/${addon}/{arch}\"" -i "${addon}/config.yaml"

      - name: ğŸš€ Commit & push changes
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git add .
          git commit -m "Update ${{ github.event.client_payload.addon }} to ${{ github.event.client_payload.version }}"
          git push
